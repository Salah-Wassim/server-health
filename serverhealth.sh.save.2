#!/bin/bash
# serverhealth

LOGFILE="health_server_report.log"

useddisk=$(df -h /mnt/c | tail -n 1 | awk '{print $5}')

used_disk() {
	df -h /mnt/c | tail -n 1 | awk '{print $5}'
}

echo "Espace disque utilisé : " $useddisk

read -p "Voulez vous définir une limite ? (y/n) : " answer

case $answer in
y|Y) while true; do
   	read -p "Entrez un nombre : " limit
   	if [[ "$limit" =~ ^[0-9]+$ ]]; then
   		echo "Limite enregistré : " $limit;
   		break
   	else
   		echo "La limite doit être un entier"
   	fi
   done;;
n|N) echo "Aucune limite défine";;
*) "Réponse incorrecte"
esac

if [[ "$useddisk" =~ ^[0-9]+%$ ]] && [ "${useddisk%\%}" -gt "$limit" ]; then
	echo "Attention l'espace disque à dépassé la limite" used_disk
else
	echo "Espace disque OK"
fi

read -p "Voulez vous rechercher un processus en cours ? (y/n) : " process

case $process in
y|Y)
	ps -f -u scorpion > allprocess
	read -p "Entrer le nom d'un processus (ex. : bash, sshd) : " entryprocess
	grep "$entryprocess" allprocess
	rm allprocess;;
n|N)
	echo "Aucun processus rechercher";;

*) echo "Réponse incorrecte"
esac

echo -e "\n============================="
echo "===     Rapport Santé     ==="
echo "============================="
echo "Date : $(date)"
echo "Espace disque utilisé : $useddisk"
echo "Limite de l'espace disque définit : $limit"
if [[ $entryprocess == "" ]]
	echo "Process recherché : $entry"
echo "===FIN==="

read -p "Souhaitez-vous enregistrer ce rapport ? (y/n) : " save

case "$save" in
y|Y)
	{
	  echo -e "\n=============================";
	  echo "===     Rapport Santé     ===";
	  echo "=============================";
	  echo "Date : $(date)";
	  echo "Espace disque utilisé : $useddisk";
	  echo "Limite de l'espace disque définit : $limit";
	  echo "Process recherché : $entryprocess";
          echo "===FIN===";
	} >> $LOGFILE
	echo "Rapport enregistré dans health_server_report.log";;
n|N)
	echo "Rapport non enregistrer, au revoir !"
	exit 0;;
*)
	echo "Réponse incorrecte"
esac
